diff -urNp stunnel-4.29-patched/src/protocol.c stunnel-4.29-current/src/protocol.c
--- stunnel-4.29-patched/src/protocol.c	2013-03-27 10:48:01.883092080 -0400
+++ stunnel-4.29-current/src/protocol.c	2013-03-27 16:04:50.906318768 -0400
@@ -38,6 +38,8 @@
 #include "common.h"
 #include "prototypes.h"
 
+#define is_prefix(a, b) (strncasecmp((a), (b), strlen(b))==0)
+
 /* \n is not a character expected in the string */
 #define LINE "%[^\n]"
 #define isprefix(a, b) (strncasecmp((a), (b), strlen(b))==0)
@@ -397,7 +399,7 @@ static void nntp_client(CLI *c) {
 }
 
 static void connect_client(CLI *c) {
-    char line[STRLEN], ntlm2[STRLEN], *encoded;
+    char line[STRLEN], ntlm2[STRLEN], *encoded, *tmpstr;
     long content_length;
     char buf[BUFSIZ];
 
@@ -419,25 +421,36 @@ static void connect_client(CLI *c) {
             fdgetline(c, c->remote_fd.fd, line);
 
             /* receive Proxy-Authenticate (phase 2) */
-            if(line[9]!='4' || line[10]!='0' || line[11]!='7') { /* code 407 */
-                s_log(LOG_ERR, "NTLM authorization request rejected");
+            if(!is_prefix(line, "HTTP/1.0 407") && !is_prefix(line, "HTTP/1.1 407")) {
+                s_log(LOG_ERR, "Proxy-Authenticate: NTLM authorization request rejected");
                 do { /* read all headers */
                     fdgetline(c, c->remote_fd.fd, line);
                 } while(*line);
                 longjmp(c->err, 1);
             }
+
             *ntlm2='\0';
             content_length=0; /* no HTTP content */
             do { /* read all headers */
                 fdgetline(c, c->remote_fd.fd, line);
                 if(isprefix(line, "Proxy-Authenticate: NTLM "))
                     safecopy(ntlm2, line+25);
-                else if(isprefix(line, "Content-Length: "))
-                    content_length=atol(line+16);
+                else if(isprefix(line, "Content-Length: ")) {
+                    content_length=strtol(line+16, &tmpstr, 10);
+                    if(tmpstr==line+16 || *tmpstr || content_length<0) {
+                        s_log(LOG_ERR, "Proxy-Authenticate: Invalid Content-Length");
+                        longjmp(c->err, 1);
+                    }
+                }
             } while(*line);
 
+            if(*ntlm2 == '\0') { /* no Proxy-Authenticate: NTLM header */
+                s_log(LOG_ERR, "Proxy-Authenticate: NTLM header not found");
+                longjmp(c->err, 1);
+            }
+
             /* read and ignore HTTP content (if any) */
-            while(content_length) {
+            while(content_length > 0) {
                 read_blocking(c, c->remote_fd.fd, buf,
                     s_min(content_length, BUFSIZ));
                 content_length-=s_min(content_length, BUFSIZ);
